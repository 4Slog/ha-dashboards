- id: maintain_comfort_band_71_73
  alias: Maintain Comfort Band 71–73°F
  description: Automatically switch HVAC between heat and cool to keep average home temperature in the 71–73°F comfort band.
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.average_home_temperature
      below: 71
      for:
        minutes: 10

    - platform: numeric_state
      entity_id: sensor.average_home_temperature
      above: 73
      for:
        minutes: 10

  # Only run when your master toggle is ON
  condition:
    - condition: state
      entity_id: input_boolean.hvac_auto_comfort
      state: "on"

  action:
    - choose:

        # === HEAT WHEN TOO COLD (<71°F) ===
        - conditions:
            - condition: numeric_state
              entity_id: sensor.average_home_temperature
              below: 71
          sequence:
            - service: climate.set_hvac_mode
              target:
                entity_id: climate.thermostat
              data:
                hvac_mode: heat
            - service: climate.set_temperature
              target:
                entity_id: climate.thermostat
              data:
                temperature: 72

        # === COOL WHEN TOO HOT (>73°F) ===
        - conditions:
            - condition: numeric_state
              entity_id: sensor.average_home_temperature
              above: 73
          sequence:
            - service: climate.set_hvac_mode
              target:
                entity_id: climate.thermostat
              data:
                hvac_mode: cool
            - service: climate.set_temperature
              target:
                entity_id: climate.thermostat
              data:
                temperature: 72

    # LOG RESULT
    - service: logbook.log
      data:
        name: HVAC Comfort Band
        message: System adjusted to maintain 71–73°F comfort range.

- id: hvac_fan_circulation_hourly
  alias: HVAC Fan Circulation Hourly
  description: Run system fan 10 minutes every hour when comfort automation is enabled and HVAC is idle.
  mode: single

  trigger:
    # Top of every hour
    - platform: time_pattern
      minutes: "0"

  condition:
    # Only if auto comfort is ON
    - condition: state
      entity_id: input_boolean.hvac_auto_comfort
      state: "on"
    # Only if HVAC is currently OFF (not actively heating or cooling)
    - condition: state
      entity_id: climate.thermostat
      state: "off"

  action:
    - service: climate.set_fan_mode
      target:
        entity_id: climate.thermostat
      data:
        fan_mode: "on"

    - delay: "00:10:00"

    - service: climate.set_fan_mode
      target:
        entity_id: climate.thermostat
      data:
        fan_mode: "auto"

- id: main_lights_master_on
  alias: Main Lights Master On
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.main_lights_master
      to: "on"
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.kitchen_light_switch
          - light.great_room_fan_and_light

- id: main_lights_master_off
  alias: Main Lights Master Off
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.main_lights_master
      to: "off"
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.kitchen_light_switch
          - light.great_room_fan_and_light
- id: great_room_blinds_open_1130
  alias: "Great Room Blinds - Open at 8:00 AM if Still Closed"
  description: "If great room blinds haven't been manually opened by 8:00 AM, open them fully"
  mode: single
  trigger:
    - platform: time
      at: "08:00:00"
  condition:
    - condition: state
      entity_id: input_boolean.great_room_blinds_auto
      state: "on"
    - condition: numeric_state
      entity_id: cover.great_room_blinds
      attribute: current_tilt_position
      above: 90
  action:
    - service: cover.set_cover_tilt_position
      target:
        entity_id: cover.great_room_blinds
      data:
        tilt_position: 50

- id: great_room_blinds_close_530
  alias: "Great Room Blinds - Close at 5:30 PM"
  description: "Close great room blinds at 5:30 PM every day"
  mode: single
  trigger:
    - platform: time
      at: "17:30:00"
  condition:
    - condition: state
      entity_id: input_boolean.great_room_blinds_auto
      state: "on"
  action:
    - service: cover.set_cover_tilt_position
      target:
        entity_id: cover.great_room_blinds
      data:
        tilt_position: 99

- id: dining_room_blinds_open_800
  alias: "Dining Room Blinds - Open at 8:00 AM if Still Closed"
  description: "If dining room blinds haven't been manually opened by 8:00 AM, open them"
  mode: single
  trigger:
    - platform: time
      at: "08:00:00"
  condition:
    - condition: state
      entity_id: input_boolean.dining_room_blinds_auto
      state: "on"
    - condition: numeric_state
      entity_id: cover.dining_room_blinds
      attribute: current_tilt_position
      above: 90
  action:
    - service: cover.set_cover_tilt_position
      target:
        entity_id: cover.dining_room_blinds
      data:
        tilt_position: 50

- id: dining_room_blinds_close_530
  alias: "Dining Room Blinds - Close at 5:30 PM"
  description: "Close dining room blinds at 5:30 PM every day"
  mode: single
  trigger:
    - platform: time
      at: "17:30:00"
  condition:
    - condition: state
      entity_id: input_boolean.dining_room_blinds_auto
      state: "on"
  action:
    - service: cover.set_cover_tilt_position
      target:
        entity_id: cover.dining_room_blinds
      data:
        tilt_position: 99

- id: study_blinds_open_weekday
  alias: "Study Blinds - Open Weekday Morning"
  description: "Tilt study blinds open at 7:55 AM Mon-Fri for wife's work schedule"
  mode: single
  trigger:
    - platform: time
      at: "07:55:00"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - condition: state
      entity_id: input_boolean.study_blinds_auto
      state: "on"
  action:
    - service: cover.set_cover_tilt_position
      target:
        entity_id: cover.blind_tilt_5b8c
      data:
        tilt_position: 70

- id: study_blinds_close_weekday
  alias: "Study Blinds - Close Weekday Evening"
  description: "Tilt study blinds closed at 5:30 PM Mon-Fri after wife's work"
  mode: single
  trigger:
    - platform: time
      at: "17:30:00"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - condition: state
      entity_id: input_boolean.study_blinds_auto
      state: "on"
  action:
    - service: cover.set_cover_tilt_position
      target:
        entity_id: cover.blind_tilt_5b8c
      data:
        tilt_position: 100

# ============================================
# WHOLE-HOME AUTOMATIONS - FAMILY ROUTINE
# ============================================

- id: morning_kitchen_lights_weekday
  alias: "Morning Kitchen Lights - Weekday"
  description: "Turn on kitchen light when motion detected in kitchen weekday mornings (6:30-10 AM)"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.vaca_ea80840db_motion
      to: "on"
  condition:
    - condition: time
      after: "06:30:00"
      before: "10:00:00"
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - condition: state
      entity_id: light.kitchen_light_switch
      state: "off"
  action:
    - service: light.turn_on
      target:
        entity_id: light.kitchen_light_switch
    - service: logbook.log
      data:
        name: Morning Routine
        message: "Kitchen light turned on - morning motion detected"

- id: away_mode_lights_off
  alias: "Away Mode - Lights Off (Paul + Tuella)"
  description: "Turn off all common area lights when both Paul and Tuella are away from home"
  mode: single
  trigger:
    - platform: state
      entity_id: person.paul
      to: "not_home"
    - platform: state
      entity_id: person.tuella_sowu
      to: "not_home"
  condition:
    - condition: state
      entity_id: person.paul
      state: "not_home"
    - condition: state
      entity_id: person.tuella_sowu
      state: "not_home"
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.kitchen_light_switch
          - light.great_room_fan_and_light
          - light.dining_room_main_light
    - service: switch.turn_off
      target:
        entity_id: switch.master_hallway
    - service: logbook.log
      data:
        name: Away Mode
        message: "Paul and Tuella are both away - common area lights turned off"

- id: welcome_home_evening_lights
  alias: "Welcome Home - Evening Kitchen Light"
  description: "Turn on kitchen light when Paul or Tuella arrives home after 5 PM"
  mode: single
  trigger:
    - platform: state
      entity_id:
        - person.paul
        - person.tuella_sowu
      to: "home"
  condition:
    - condition: time
      after: "17:00:00"
      before: "23:59:59"
  action:
    - service: light.turn_on
      target:
        entity_id: light.kitchen_light_switch
    - service: logbook.log
      data:
        name: Welcome Home
        message: "Someone arrived home after 5 PM - kitchen light turned on"

- id: front_porch_light_sunset_on
  alias: "Front Porch Light - Sunset Failsafe"
  description: "30 min after sunset, turn on front porch if Alexa routine hasn't already"
  mode: single
  trigger:
    - platform: sun
      event: sunset
      offset: "+00:30:00"
  condition:
    - condition: state
      entity_id: input_boolean.front_porch_virtual_toggle
      state: "off"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.front_porch_virtual_toggle

- id: front_porch_light_sunrise_off
  alias: "Front Porch Light - Sunrise Failsafe"
  description: "30 min after sunrise, turn off front porch if Alexa routine hasn't already"
  mode: single
  trigger:
    - platform: sun
      event: sunrise
      offset: "+00:30:00"
  condition:
    - condition: state
      entity_id: input_boolean.front_porch_virtual_toggle
      state: "on"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.front_porch_virtual_toggle

- id: front_porch_virtual_toggle_sync
  alias: "Front Porch Light - Virtual Toggle Sync"
  description: "When front porch virtual toggle changes, send command to Alexa to control the physical Amazon switch"
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.front_porch_virtual_toggle
      to: "on"
    - platform: state
      entity_id: input_boolean.front_porch_virtual_toggle
      to: "off"
  action: []

- id: midnight_lights_off_backup
  alias: "2 AM Backup - Common Area Lights Off"
  description: "Backup to sleep detection - turn off common area lights at 2 AM if Paul or Tuella are home and no kitchen motion"
  mode: single
  trigger:
    - platform: time
      at: "02:00:00"
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: person.paul
          state: "home"
        - condition: state
          entity_id: person.tuella_sowu
          state: "home"
    # Don't run if Mauriece is in the kitchen
    - condition: state
      entity_id: binary_sensor.vaca_ea80840db_motion
      state: "off"
      for:
        minutes: 30
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.kitchen_light_switch
          - light.great_room_fan_and_light
          - light.dining_room_main_light
    - service: logbook.log
      data:
        name: 2 AM Backup
        message: "2 AM backup triggered - common area lights turned off"

- id: kitchen_light_auto_off_no_motion
  alias: "Kitchen Light Auto-Off - No Motion 45 Min"
  description: "Turn off kitchen light after 45 minutes of no motion on kitchen tablet"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.vaca_ea80840db_motion
      to: "off"
      for:
        minutes: 45
  condition:
    - condition: state
      entity_id: light.kitchen_light_switch
      state: "on"
  action:
    - service: light.turn_off
      target:
        entity_id: light.kitchen_light_switch
    - service: logbook.log
      data:
        name: Kitchen Auto-Off
        message: "Kitchen light turned off - no motion detected for 45 minutes"

- id: kitchen_light_auto_on_motion
  alias: "Kitchen Light Auto-On - Motion Detected"
  description: "Turn on kitchen light when motion detected on kitchen tablet"
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.vaca_ea80840db_motion
      to: "on"
  condition:
    - condition: state
      entity_id: light.kitchen_light_switch
      state: "off"
  action:
    - service: light.turn_on
      target:
        entity_id: light.kitchen_light_switch
    - service: logbook.log
      data:
        name: Kitchen Auto-On
        message: "Kitchen light turned on - motion detected on kitchen tablet"

- id: sleep_detection_bedtime_routine
  alias: "Sleep Detection - Bedtime Routine"
  description: "When both Paul and Tuella are asleep, turn off all lights, fans, close blinds, sleep tablet"
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.sm_s928u1_sleep_confidence
    - platform: state
      entity_id: sensor.tuellas_samsung_sleep_confidence
    - platform: state
      entity_id: sensor.sm_s928u1_detected_activity
    - platform: state
      entity_id: sensor.tuellas_samsung_detected_activity
    - platform: state
      entity_id: binary_sensor.vaca_ea80840db_motion
      to: "off"
    - platform: state
      entity_id: binary_sensor.great_room_ringcsm_motion
      to: "off"
    - platform: state
      entity_id: binary_sensor.living_room_motion_3
      to: "off"
  condition:
    # Must be after 9:30 PM
    - condition: time
      after: "21:30:00"
    # At least one light must be on (prevent re-firing after already done)
    - condition: or
      conditions:
        - condition: state
          entity_id: light.kitchen_light_switch
          state: "on"
        - condition: state
          entity_id: light.great_room_fan_and_light
          state: "on"
        - condition: state
          entity_id: light.dining_room_main_light
          state: "on"
    # Both sleep confidence above 75%
    - condition: numeric_state
      entity_id: sensor.sm_s928u1_sleep_confidence
      above: 75
    - condition: numeric_state
      entity_id: sensor.tuellas_samsung_sleep_confidence
      above: 75
    # Both phones showing still
    - condition: state
      entity_id: sensor.sm_s928u1_detected_activity
      state: "still"
    - condition: state
      entity_id: sensor.tuellas_samsung_detected_activity
      state: "still"
    # No motion anywhere for 20+ minutes (also catches Mauriece still being up)
    - condition: state
      entity_id: binary_sensor.vaca_ea80840db_motion
      state: "off"
      for:
        minutes: 20
    - condition: state
      entity_id: binary_sensor.great_room_ringcsm_motion
      state: "off"
      for:
        minutes: 20
    - condition: state
      entity_id: binary_sensor.living_room_motion_3
      state: "off"
      for:
        minutes: 20
  action:
    # Turn off all lights
    - service: light.turn_off
      target:
        entity_id:
          - light.great_room_fan_and_light
          - light.dining_room_main_light
          - light.kitchen_light_switch
    # Turn off fans
    - service: fan.turn_off
      target:
        entity_id:
          - fan.great_room_fan_and_light
          - fan.dining_room_main_fan
    # Turn off master hallway
    - service: switch.turn_off
      target:
        entity_id: switch.master_hallway
    # Close blinds
    - service: cover.set_cover_tilt_position
      target:
        entity_id: cover.great_room_blinds
      data:
        tilt_position: 99
    - service: cover.set_cover_tilt_position
      target:
        entity_id: cover.dining_room_blinds
      data:
        tilt_position: 99
    - service: cover.set_cover_tilt_position
      target:
        entity_id: cover.blind_tilt_5b8c
      data:
        tilt_position: 100
    # Sleep kitchen tablet
    - service: number.set_value
      target:
        entity_id: number.vaca_ea80840db_screen_brightness
      data:
        value: 0
    - service: button.press
      target:
        entity_id: button.vaca_ea80840db_sleep_screen
    - service: logbook.log
      data:
        name: Sleep Detection
        message: "Both Paul and Tuella asleep - bedtime routine executed"

# ══════════════════════════════════════════════════════
# 19. HA Startup Notification
# ══════════════════════════════════════════════════════
- id: ha_startup_notification
  alias: "HA Startup Notification"
  description: "Notify Paul's phone whenever Home Assistant restarts"
  trigger:
    - platform: homeassistant
      event: start
  action:
    - delay: "00:00:30"
    - service: notify.mobile_app_sm_s928u1
      data:
        title: "Home Assistant Started"
        message: "HA is back online. All automations are active."
    - service: notify.mobile_app_p13pro
      data:
        title: "Home Assistant Started"
        message: "HA is back online. All automations are active."

# ══════════════════════════════════════════════════════
# 20. MQTT Broker Unavailable Notification
# ══════════════════════════════════════════════════════
- id: mqtt_broker_unavailable_notify
  alias: "MQTT Broker Unavailable Notification"
  description: "Notify Paul when MQTT broker goes unavailable"
  trigger:
    - platform: event
      event_type: mqtt_disconnected
  action:
    - service: notify.mobile_app_sm_s928u1
      data:
        title: "MQTT Broker Down"
        message: "Mosquitto MQTT broker disconnected. Ring, Wyze, and other MQTT devices may be offline."
    - service: notify.mobile_app_p13pro
      data:
        title: "MQTT Broker Down"
        message: "Mosquitto MQTT broker disconnected. Ring, Wyze, and other MQTT devices may be offline."

# ══════════════════════════════════════════════════════
# 21. MQTT Broker Reconnected Notification
# ══════════════════════════════════════════════════════
- id: mqtt_broker_reconnected_notify
  alias: "MQTT Broker Reconnected Notification"
  description: "Notify Paul when MQTT broker reconnects"
  trigger:
    - platform: event
      event_type: mqtt_connected
  action:
    - service: notify.mobile_app_sm_s928u1
      data:
        title: "MQTT Broker Reconnected"
        message: "Mosquitto MQTT broker is back online."
    - service: notify.mobile_app_p13pro
      data:
        title: "MQTT Broker Reconnected"
        message: "Mosquitto MQTT broker is back online."

# ══════════════════════════════════════════════════════
# 22. HA Restart - Kitchen Light Cleanup
# If HA restarts while kitchen light is on but no motion,
# turn it off (lost timer recovery).
# ══════════════════════════════════════════════════════
- id: ha_restart_kitchen_light_cleanup
  alias: "HA Restart - Kitchen Light Cleanup"
  description: "On HA start, turn off kitchen light if on with no motion (lost timer recovery)"
  trigger:
    - platform: homeassistant
      event: start
  action:
    - delay: "00:01:00"
    - condition: and
      conditions:
        - condition: state
          entity_id: light.kitchen_light_switch
          state: "on"
        - condition: state
          entity_id: binary_sensor.vaca_ea80840db_motion
          state: "off"
    - service: light.turn_off
      target:
        entity_id: light.kitchen_light_switch
    - service: logbook.log
      data:
        name: HA Restart Cleanup
        message: "Kitchen light turned off on startup - was on with no motion (lost timer recovery)"

# ══════════════════════════════════════════════════════
# 23. HA Restart - Wake Kitchen Tablet Screen
# If HA crashed mid-sleep-routine, tablet screen may be
# stuck at brightness 0. Wake it on restart.
# ══════════════════════════════════════════════════════
- id: ha_restart_wake_kitchen_tablet
  alias: "HA Restart - Wake Kitchen Tablet Screen"
  description: "On HA start, restore kitchen tablet to normal brightness in case it was stuck dark"
  trigger:
    - platform: homeassistant
      event: start
  action:
    - delay: "00:01:30"
    - service: number.set_value
      target:
        entity_id: number.vaca_ea80840db_screen_brightness
      data:
        value: 100
    - service: button.press
      target:
        entity_id: button.vaca_ea80840db_wake_screen
    - service: logbook.log
      data:
        name: HA Restart Cleanup
        message: "Kitchen tablet screen woken on HA startup"
